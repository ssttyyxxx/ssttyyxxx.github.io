import{_ as p,c as e,o as s,a as t}from"./app.5b22e94d.js";const m=JSON.parse('{"title":"CentOS7 openssl&openssh 升级踩坑全记录","description":"","frontmatter":{"title":"CentOS7 openssl&openssh 升级踩坑全记录","date":"2020-05-20T00:00:00.000Z","draft":false,"tags":[2020,"centos7"]},"headers":[],"relativePath":"tech/linux/20200520.md"}'),o={name:"tech/linux/20200520.md"},l=t(`<p>从一个全新的centos7虚拟机到手，走一个升级openssh&amp;openssl的流程</p><p>更新一下：</p><p>yum update</p><p>安装gcc编译器：</p><p>yum install gcc</p><p>安装zlib依赖库：</p><p>yum install zlib-devel</p><p>安装openssl依赖库</p><p>yum install openssl-devel</p><p>ifconfig，如果输入“bash: ifconfig: 未找到命令”**</p><p>yum install -y net-tools.x86_64</p><p>Operating system: x86_64-whatever-linux2 You need Perl 5.</p><p>下载perl5链接：</p><p><a href="https://www.cpan.org/src/5.0/perl-5.30.1.tar.gz" target="_blank" rel="noreferrer">https://www.cpan.org/src/5.0/perl-5.30.1.tar.gz</a></p><p>解压：</p><p>tar -xzf perl-5.30.1.tar.gz</p><p>预编译：</p><p>./Configure -des -Dprefix=$HOME/localperl</p><p>编译：</p><p>make</p><p>测试：</p><p>make test</p><p>安装：</p><p>make install</p><p>安装openssl</p><p>下载：</p><p><a href="https://www.openssl.org/source/openssl-1.1.1c.tar.gz" target="_blank" rel="noreferrer">https://www.openssl.org/source/openssl-1.1.1c.tar.gz</a></p><p>解压：</p><p>tar -zxvf openssl-1.1.1c.tar.gz</p><p>预编译&amp;配置：</p><p>./config --prefix=/usr/local/openssl #如果报错，按照需要安装perl以及gcc包</p><p>编译&amp;安装：</p><p>make &amp;&amp; make install</p><p>备份：</p><p>mv /usr/bin/openssl /usr/bin/openssl.bak</p><p>建立软链接：</p><p>ln -sf /usr/local/openssl/bin/openssl /usr/bin/openssl</p><p>更新动态链接库数据：</p><p>echo &quot;/usr/local/openssl/lib&quot; &gt;&gt; /etc/ld.so.conf</p><p>设置生效：</p><p>ldconfig</p><p>查看版本：</p><p>openssl version</p><p>安装openssh8.2</p><p>下载：<a href="https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-8.2p1.tar.gz" target="_blank" rel="noreferrer">https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-8.2p1.tar.gz</a></p><p>解压：tar –zxvf openssh-8.2p1.tar.gz</p><p>修改源码：解压主目录下，找到sshd.c文件，vim sshd.c</p><p>找到：</p><p>server_accept_loop(&amp;sock_in,&amp;sock_out,</p><p>&amp;newsock,config_s);c</p><p>修改为：</p><p>sd_notify(0, &quot;READY=1&quot;);</p><p>server_accept_loop(&amp;sock_in, &amp;sock_out,</p><pre><code>     &amp;newsock, config_s);
</code></pre><p>并加上引用头文件：</p><p>#include &lt;systemd/sd-daemon.h&gt;</p><p>预编译：</p><p>./configure --prefix=/usr/ --sysconfdir=/etc/ssh --with-openssl-includes=/usr/local/ssl/include --with-ssl-dir=/usr/local/ssl --with-zlib --with-md5-passwords --with-pam</p><p>修改Makefile文件：</p><p>原来是：</p><p>LIBS=-lcrypto -ldl -lutil -lz -lcrypt -lresolv</p><p>修改后：</p><p>LIBS=-lcrypto -ldl -lutil -lz -lcrypt -lresolv -lsystemd</p><p>configure: error: *** zlib.h missing - please install first or check config.log</p><p>yum -y install zlib-devel</p><p>configure: error: *** working libcrypto not found, check config.log</p><p>yum install -y openssl-devel</p><p>configure: error: PAM headers not found</p><p>yum-yinstallpam-devel</p><p>编译：make</p><p>sshd.c:44:31: 致命错误：systemd/sd-daemon.h：没有那个文件或目录</p><p>yum install systemd-devel</p><p>安装：</p><p>make install</p><p>检查：</p><p>sshd -t</p><p>/etc/ssh/sshd_config line 79: Unsupported option GSSAPIAuthentication</p><p>/etc/ssh/sshd_config line 80: Unsupported option GSSAPICleanupCredentials</p><p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</p><p>@ WARNING: UNPROTECTED PRIVATE KEY FILE! @</p><p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</p><p>Permissions 0640 for &#39;/etc/ssh/ssh_host_rsa_key&#39; are too open.</p><p>It is required that your private key files are NOT accessible by others.</p><p>This private key will be ignored.</p><p>Unable to load host key &quot;/etc/ssh/ssh_host_rsa_key&quot;: bad permissions</p><p>Unable to load host key: /etc/ssh/ssh_host_rsa_key</p><p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</p><p>@ WARNING: UNPROTECTED PRIVATE KEY FILE! @</p><p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</p><p>Permissions 0640 for &#39;/etc/ssh/ssh_host_ecdsa_key&#39; are too open.</p><p>It is required that your private key files are NOT accessible by others.</p><p>This private key will be ignored.</p><p>Unable to load host key &quot;/etc/ssh/ssh_host_ecdsa_key&quot;: bad permissions</p><p>Unable to load host key: /etc/ssh/ssh_host_ecdsa_key</p><p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</p><p>@ WARNING: UNPROTECTED PRIVATE KEY FILE! @</p><p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</p><p>Permissions 0640 for &#39;/etc/ssh/ssh_host_ed25519_key&#39; are too open.</p><p>It is required that your private key files are NOT accessible by others.</p><p>This private key will be ignored.</p><p>Unable to load host key &quot;/etc/ssh/ssh_host_ed25519_key&quot;: bad permissions</p><p>Unable to load host key: /etc/ssh/ssh_host_ed25519_key</p><p>sshd: no hostkeys available -- exiting.</p><p>修改权限：</p><p>cd /etc/ssh/</p><p>​</p><p>chmod 600 ssh_host_ecdsa_key</p><p>​</p><p>chmod 600 ssh_host_rsa_key</p><p>​</p><p>chmod 600 ssh_host_ed25519_key</p><p>检查版本：</p><p>ssh -V</p><p>修改端口：</p><p>vim /etc/ssh/sshd_config</p><p>Port 2222 #修改端口为2222</p><p>PermitRootLogin yes #允许root远程登录</p><p>#GSSAPIAuthentication yes #只管禁掉</p><p>#GSSAPICleanupCredentials no #只管禁掉</p><p>重启服务：</p><p>service sshd restart</p><p>报错：</p><p>Job for sshd.service failed because the control process exited with error code. See &quot;systemctl status sshd.service&quot; and &quot;journalctl -xe&quot; for details.</p><p>查看日志：</p><p>journalctl -xe</p><p>报错日志：</p><p>5月 20 16:36:58 localhost.localdomain sshd[129668]: error: Bind to port 2222 on 0.0.0.0 failed: Permission denied.</p><p>5月 20 16:36:58 localhost.localdomain sshd[129668]: fatal: Cannot bind any address.</p><p>5月 20 16:36:58 localhost.localdomain systemd[1]: sshd.service: main process exited, code=exited, status=255/n/a</p><p>5月 20 16:36:58 localhost.localdomain systemd[1]: Failed to start OpenSSH server daemon.</p><p>关闭selinux：</p><p>setenforce 0</p><p>重启服务：</p><p>service sshd restart</p><p>永久关闭selinx：</p><p>vim /etc/sysconfig/selinux</p><p>将SELINUX=enforcing改为SELINUX=disabled</p><p>重启后生效</p><p>对了，千万不要在正式环境这么操作，因为这样很危险。</p><p>正确的步骤是先把服务器telnet打开，再远程连上telnet，使用telnet操作这一切，不然要是升级过程中出了问题，只能跑到机房去搞了。</p><p>于是便有了下面的telnet踩坑：</p><p>检查是不是安装了telnet：</p><p>rpm -qa | grep telnet # 安装了telnet和telnet-server</p><p>rpm -qa xinetd #是否安装了xinetd，telnet的自启动依赖它</p><p>安装：</p><p>yum install telnet-server</p><p>yum install telnet</p><p>yum install -y xinetd</p><p>启动：</p><p>systemctl start telnet.socket #启动telent服务</p><p>systemctl start xinetd.service #启动守护进程</p><p>远程连接telnet，输入正确账户密码报错：</p><p>Login incorrect</p><p>执行：</p><p>mv /etc/securetty /etc/securettyold</p><p>再次远程登录，成功。</p><p>最后插一句：一般来说，服务器的防火墙和selinux是不开的。因为遇到很多问题，找不到答案，最后发现是这两东西捣的鬼，真是气人。</p>`,157),n=[l];function r(a,i,c,d,h,u){return s(),e("div",null,n)}const y=p(o,[["render",r]]);export{m as __pageData,y as default};
